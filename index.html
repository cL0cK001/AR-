<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ARアニメーション選択</title>
  <script src="aframe.min.js"></script>
  <script src="aframe-ar.js"></script>
  <script src="cdn.tailwindcss.com"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.3.1/aframe/build/aframe-ar-nft.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

  <style>
    /* ARコンテナとメニューを全画面表示にするための基本スタイル */
    body, html {
      margin: 0;
      padding: 0; /* ズレ防止のため追加 */
      overflow: hidden;
      width: 100%;
      height: 100%;
      font-family: 'Inter', sans-serif;
      box-sizing: border-box;
    }
    
    /* 2つのメインコンテナにもマージン・パディングのリセットを適用 */
    #ar-container, #selection-menu {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }

    /* AR表示関連の要素を強制的に左上に固定し、全画面にする */
    a-scene[embedded] {
      width: 100% !important;
      height: 100% !important;
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      margin: 0 !important;
      padding: 0 !important;
      z-index: 1; /* 基準 */
    }

    .a-canvas {
      width: 100% !important;
      height: 100% !important;
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      margin: 0 !important;
      padding: 0 !important;
      z-index: 1; /* a-scene と同じ階層に */
    }

    video {
      object-fit: cover !important;
      width: 100% !important;
      height: 100% !important;
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      margin: 0 !important;
      padding: 0 !important;
      z-index: -1; /* 最背面に配置 */
    }

    /* 戻るボタンの z-index を ARシーンより手前に設定 */
    #btn-back {
      z-index: 10 !important; /* Tailwindのz-10より優先させる */
    }
  </style>
</head>
<body class="bg-black">
  <div id="selection-menu" class="flex flex-col items-center justify-center p-8 space-y-6 bg-gray-100">
    <h1 class="text-3xl font-bold text-gray-800 mb-4">ARアニメーションを選択</h1>
    <button id="btn-left" data-type="left" class="w-full max-w-sm p-4 bg-blue-500 text-white rounded-lg shadow-md text-lg font-semibold hover:bg-blue-600 transition duration-200">
      左に行く
    </button>
    <button id="btn-right" data-type="right" class="w-full max-w-sm p-4 bg-green-500 text-white rounded-lg shadow-md text-lg font-semibold hover:bg-green-600 transition duration-200">
      右に行く
    </button>
    <button id="btn-approach" data-type="approach" class="w-full max-w-sm p-4 bg-yellow-500 text-white rounded-lg shadow-md text-lg font-semibold hover:bg-yellow-600 transition duration-200">
      近づく
    </button>
    <button id="btn-away" data-type="away" class="w-full max-w-sm p-4 bg-red-500 text-white rounded-lg shadow-md text-lg font-semibold hover:bg-red-600 transition duration-200">
      遠ざかる
    </button>
  </div>

  <div id="ar-container" class="hidden relative">

  <a-scene embedded
             arjs="sourceType: webcam;
                   debugUIEnabled: false;
                   sourceParameters: {
                     video: {
                       width: { ideal: 1280 },
                       height: { ideal: 960 },
                       facingMode: { ideal: 'environment' }
                     }
                   }">
      <a-marker id="marker" type="pattern" url="AR-marker.patt">
      <a-entity gltf-model="#walking" animation-mixer></a-entity>
        </a-marker>

      <a-entity camera></a-entity>
    </a-scene>
    <div id="txt" style="position: fixed; bottom: 1rem; left: 1rem; z-index: 10; padding: 0.5rem; background-color: rgba(0,0,0,0.5); color: white; border-radius: 0.5rem; font-size: 0.875rem;">
      </div>

 <button id="btn-back" class="fixed bottom-6 z-10 p-3 bg-gray-800 text-white rounded-lg shadow-lg hover:bg-gray-900 transition duration-200" style="right: 10px;">
      メニューに戻る
    </button>
    
  </div>

 <script>
    document.addEventListener('DOMContentLoaded', () => {
      // 必要なHTML要素を取得
      const menu = document.getElementById('selection-menu');
      const arContainer = document.getElementById('ar-container');
      const marker = document.getElementById('marker');
      const backButton = document.getElementById('btn-back');
      const txtDisplay = document.getElementById('txt');

      // センサーデータの格納用変数
      let alpha = 0, beta = 0, gamma = 0;
      
      // ★ 現在のアニメーション状態 ('approach', 'away', 'left', 'right', または '')
      let currentMode = ''; 
      // ★ 状態が切り替わったか判定するための変数
      let lastAnimationType = '';

      // -----------------------------------------------------------------
      // ★ 1. 新しいロジックのイベントリスナー関数を定義
      // -----------------------------------------------------------------
      const gyroListener = (event) => {
          beta = event.beta;
          gamma = event.gamma;

          if (event.webkitCompassHeading !== undefined) {
              alpha = event.webkitCompassHeading; // iOS
          } 
          else if (event.alpha !== null) {
              alpha = (360 - event.alpha + 360) % 360; // Android
          }

          if (txtDisplay && !arContainer.classList.contains('hidden')) {
              displayData();
              
              // ★ 2. 'approach' か 'away' モードの時だけ、ジャイロでアニメーションをチェック
              if (currentMode === 'approach' || currentMode === 'away') {
                checkGyroAnimation(alpha);
              }
          }
      };

      // 選択ボタンにイベントリスナーを設定
      const selectionButtons = document.querySelectorAll('#selection-menu button');
      selectionButtons.forEach(button => {
        button.addEventListener('click', () => {
          const animationType = button.getAttribute('data-type');
          startAR(animationType);
        });
      });

      // 「メニューに戻る」ボタンの処理
      backButton.addEventListener('click', () => {
        showMenu();
      });

      /**
       * ARシーンを開始する関数
       */
      async function startAR(type) {

        // ★ 3. どのモードで開始したか保存
        currentMode = type;
        lastAnimationType = ''; // 状態をリセット

        // (センサー許可リクエストは変更なし)
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
          try {
            const permissionState = await DeviceOrientationEvent.requestPermission(); 
            if (permissionState === 'granted') {
              window.addEventListener("deviceorientationabsolute", gyroListener, true);
              window.addEventListener("deviceorientation", gyroListener, true);
              if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                await DeviceMotionEvent.requestPermission();
              }
            } else {
              alert('「向きセンサー」の利用が許可されませんでした。');
            }
          } catch (error) {
            console.error('センサーの許可リクエスト中にエラー:', error);
          }
        }
        
        // (モデルの作成)
        const existingModel = document.getElementById('current-model');
        if (existingModel) {
          marker.removeChild(existingModel);
        }
        const model = document.createElement('a-entity');
        model.setAttribute('id', 'current-model');
        model.setAttribute('gltf-model', 'birditi.glb'); 
        model.setAttribute('animation-mixer', {}); 

        // -----------------------------------------------------------------
        // ★ 4. switch文を修正
        // -----------------------------------------------------------------
        switch (type) {
          case 'left':
            model.setAttribute('rotation', '90 -90 180');
            model.setAttribute('scale', '3 3 3');
            model.setAttribute('animation', {
                property: 'position', from: '0 0 0', to: '-5 0 0', 
                dur: 4000, dir: 'normal', loop: true
            });
            break;
            
          case 'right':
            model.setAttribute('rotation', '90 90 180');
            model.setAttribute('scale', '3 3 3');
            model.setAttribute('animation', {
              property: 'position', from: '0 0 0', to: '5 0 0', 
              dur: 4000, dir: 'normal', loop: true
            });
            break;

          case 'approach':
          case 'away':
            // ★ 'approach' か 'away' が押されたら、ジャイロによる自動切り替えを開始
            // ★ 初期状態をセットするため、checkGyroAnimationを1回呼び出す
            checkGyroAnimation(alpha); 
            break;
        }
        // -----------------------------------------------------------------

        marker.appendChild(model);
        menu.classList.add('hidden');
        arContainer.classList.remove('hidden');

        // ★ リサイズ問題の対策
        setTimeout(() => window.dispatchEvent(new Event('resize')), 100);
      }

      // -----------------------------------------------------------------
      // ★ 5. ジャイロでアニメーションを切り替える新関数
      // -----------------------------------------------------------------
      function checkGyroAnimation(currentAlpha) {
        const model = document.getElementById('current-model');
        if (!model) return; // モデルがなければ何もしない

        let newAnimationType = '';

        // ★ ユーザー様のロジックをここに実装
        // 60〜150 は "away"
        if (currentAlpha >= 60 && currentAlpha < 150) { // ユーザーの条件だと150もaway
            newAnimationType = 'away';
        } else {
            // それ以外 (150〜360, 0〜60) は "approach"
            newAnimationType = 'approach';
        }
        
        // ★ 状態が変更された場合のみ、アニメーションを再設定 (パフォーマンスのため)
        if (newAnimationType !== lastAnimationType) {
            lastAnimationType = newAnimationType;
            
            if (newAnimationType === 'approach') {
                // "近づく" アニメーション
                model.setAttribute('rotation', '-90 0 0');
                model.setAttribute('scale', '1 1 1'); 
                model.setAttribute('animation', {
                  property: 'scale', from: '1 1 1', to: '20 20 20',
                  dur: 10000, loop: false
                });
            } else { // 'away'
                // "遠ざかる" アニメーション
                model.setAttribute('rotation', '90 0 180');
                model.setAttribute('scale', '10 10 10'); 
                model.setAttribute('animation', {
                  property: 'scale', from: '5 5 5', to: '1 1 1',
                  dur: 20000, loop: false
                });
            }
        }
      }

      /**
       * メニュー画面に戻る関数
       */
      function showMenu() {
        arContainer.classList.add('hidden');
        menu.classList.remove('hidden');

        const existingModel = document.getElementById('current-model');
        if (existingModel) {
          marker.removeChild(existingModel);
        }
        
        window.removeEventListener("deviceorientationabsolute", gyroListener, true);
        window.removeEventListener("deviceorientation", gyroListener, true);
        
        if (txtDisplay) {
          txtDisplay.innerHTML = "";
        }
      }

      /**
       * センサーデータを画面に表示する関数
       */
      function displayData() {
        if(txtDisplay) {
          // ★ 現在のモード（押したボタン）と、ジャイロが検出したアニメーションを表示
          let animationStatus = (currentMode === 'approach' || currentMode === 'away') ? lastAnimationType : currentMode;
          
          txtDisplay.innerHTML = `<b>モード: ${animationStatus}</b><br>`
                               + `alpha (方位): ${Math.round(alpha)}°<br>`
                               + `beta (前後):  ${Math.round(beta)}°<br>`
                               + `gamma (左右): ${Math.round(gamma)}°`;
        }
      }
    });
  </script>
</body>
</html>